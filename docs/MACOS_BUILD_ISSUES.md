# macOS Build Issues and Solutions

## Overview

This document outlines known build issues specific to macOS development environments and their solutions.

## Issue: Tauri Build Failures with Resource Fork Files

### Problem Description

On macOS file systems (HFS+ and APFS), the system automatically creates resource fork files (also known as AppleDouble files) with names starting with `._` for files that contain extended attributes or metadata. These files are not valid UTF-8 text files, which causes Tauri's build script to panic when it tries to read them as TOML configuration files.

**Error Symptoms:**

```text
thread 'main' panicked at /Users/.../tauri-2.5.1/build.rs:418:25:
failed to define permissions for core:path: failed to read file '.../_default.toml': 
stream did not contain valid UTF-8
```

### Root Cause

1. macOS creates `._*` files (resource forks) during file operations
2. These files get created in the `target/debug/build/tauri-*/out/permissions/path/autogenerated/` directory
3. Tauri's build script attempts to read all `.toml` files in this directory
4. The `._default.toml` file is not valid UTF-8, causing the build to fail

### Solutions Implemented

#### 1. Workspace Configuration

The Tauri app (`src-tauri`) has been excluded from the main workspace to prevent it from blocking workspace-wide builds:

```toml
# Cargo.toml
[workspace]
members = [
  "agents/orchestrator",
  "agents/ingestion", 
  "agents/retrieval",
  "agents/critic",
  "agents/telemetry",
  "agents/planner-adapter",
  "rust-backend",
]
exclude = [
  "src-tauri",  # Excluded due to macOS resource fork issues
]
```

#### 2. Separate Build Script

A dedicated build script `build-tauri.sh` is provided for building the Tauri app:

```bash
#!/bin/bash
echo "Building Tauri app separately..."

# Clean up resource fork files
dot_clean . 2>/dev/null
find . -name "._*" -type f -delete 2>/dev/null

# Set environment variables to prevent resource fork creation
export COPYFILE_DISABLE=1
export COPY_EXTENDED_ATTRIBUTES_DISABLE=1

# Build Tauri in its own directory
cd src-tauri
cargo check

echo "Tauri build completed"
```

#### 3. Git Configuration

The `.gitignore` file already includes patterns to exclude resource fork files:

```gitignore
# macOS AppleDouble files
._*
.DS_Store
.AppleDouble
.LSOverride
```

### Development Workflow

#### For Regular Development (Non-Tauri)

```bash
# This works normally and includes all packages except Tauri
cargo check --workspace
cargo build --workspace
cargo test --workspace
```

#### For Tauri Development

```bash
# Use the dedicated script
./build-tauri.sh

# Or manually:
cd src-tauri
COPYFILE_DISABLE=1 COPY_EXTENDED_ATTRIBUTES_DISABLE=1 cargo check
```

#### For Full Project Builds

```bash
# Build workspace first
cargo build --workspace

# Then build Tauri separately
./build-tauri.sh
```

### Prevention Strategies

#### 1. Environment Variables

Set these environment variables in your shell profile (`.zshrc`, `.bashrc`, etc.):

```bash
export COPYFILE_DISABLE=1
export COPY_EXTENDED_ATTRIBUTES_DISABLE=1
```

#### 2. Regular Cleanup

Periodically clean resource fork files:

```bash
# Clean current directory
dot_clean .

# Or manually remove them
find . -name "._*" -type f -delete
```

#### 3. Build Script Integration

The `src-tauri/build.rs` has been modified to set environment variables:

```rust
use std::env;

fn main() {
    // Set environment variables to prevent macOS resource fork creation
    env::set_var("COPYFILE_DISABLE", "1");
    env::set_var("COPY_EXTENDED_ATTRIBUTES_DISABLE", "1");
    
    tauri_build::build()
}
```

### Troubleshooting

#### If you encounter UTF-8 errors

1. **Clean the project:**

   ```bash
   cargo clean
   dot_clean .
   find . -name "._*" -type f -delete
   ```

2. **Check for resource fork files:**

   ```bash
   find . -name "._*" -type f
   ```

3. **Use the dedicated build script:**

   ```bash
   ./build-tauri.sh
   ```

4. **If the issue persists, try building on a different file system:**
   - Move the project to a case-sensitive file system
   - Use a Linux container or VM
   - Use GitHub Actions for CI/CD builds

#### If workspace builds fail

1. **Verify Tauri is excluded:**

   ```bash
   cargo metadata --format-version 1 | jq '.workspace_members'
   ```

2. **Build individual packages:**

   ```bash
   cargo check -p orchestrator
   cargo check -p stack-telemetry
   # etc.
   ```

### Alternative Solutions (Future Considerations)

1. **Upgrade Tauri:** Future versions may handle this issue better
2. **Custom Build Script:** Implement a build script that filters out `._*` files
3. **Docker Development:** Use containerized development to avoid macOS file system issues
4. **File System Migration:** Consider using a case-sensitive APFS volume for development

### Related Issues

- [Tauri Issue #1234](https://github.com/tauri-apps/tauri/issues/1234) (example)
- [Rust Issue #5678](https://github.com/rust-lang/cargo/issues/5678) (example)

### Testing

To verify the fixes are working:

```bash
# Should complete without errors
cargo check --workspace

# Should show Tauri is excluded
cargo metadata --format-version 1 | jq '.workspace_members' | grep -v tauri

# Should build Tauri separately
./build-tauri.sh
```

---

**Last Updated:** $(date)
**Affects:** macOS developers using Tauri 2.5.x
**Status:** Workaround implemented, monitoring for upstream fixes
